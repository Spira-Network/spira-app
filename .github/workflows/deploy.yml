name: Production Deployment

concurrency:
    group: production
    cancel-in-progress: true

on:
    push:
        branches: [main]

jobs:
    deployment:
        name: Deploy to production
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Create GitHub deployment
              uses: chrnorm/deployment-action@v2
              id: deployment
              with:
                  token: '${{ github.token }}'
                  environment-url: https://spira.network
                  environment: production

            - name: Deploy to Vercel
              uses: amondnet/vercel-action@v25
              with:
                  vercel-token: ${{ secrets.VERCEL_TOKEN }}
                  vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
                  vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
                  vercel-args: '--prod'

            - name: Update deployment status (success)
              if: success()
              uses: chrnorm/deployment-status@v2
              with:
                  token: '${{ github.token }}'
                  environment-url: ${{ steps.deployment.outputs.environment_url }}
                  deployment-id: ${{ steps.deployment.outputs.deployment_id }}
                  state: 'success'

            - name: Update deployment status (failure)
              if: failure()
              uses: chrnorm/deployment-status@v2
              with:
                  token: '${{ github.token }}'
                  environment-url: ${{ steps.deployment.outputs.environment_url }}
                  deployment-id: ${{ steps.deployment.outputs.deployment_id }}
                  state: 'failure'
